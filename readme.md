# 工作流引擎技术说明文档

## 1. 项目概述

### 1.1 项目简介
本项目是一个基于PyQt6的节点式工作流引擎，采用图形化界面让用户通过拖拽节点和连接线来构建和执行工作流。该引擎支持多种数据类型的节点处理，具有可视化编辑、工作流保存与加载、节点执行等功能。

### 1.2 技术栈
- **GUI框架**: PyQt6
- **编程语言**: Python 3.10+
- **数据存储**: JSON格式
- **架构模式**: MVC (Model-View-Controller)

### 1.3 核心功能
- 可视化节点编辑器
- 节点拖拽与连接
- 工作流保存与加载
- 节点执行引擎
- 多种数据类型支持（int, str, bool, float, logic）
- 可折叠侧边栏
- 右键菜单操作

## 2. 系统架构

### 2.1 整体架构
系统采用MVC架构模式，分为三个主要部分：
- **Model**: 节点和连接的数据模型
- **View**: 画布、节点、连接线等可视化组件
- **Controller**: 事件处理、工作流执行等控制逻辑

### 2.2 模块结构
```
WorkFlowEngine/
├── Canvas/                 # 画布相关模块
│   ├── CanvasWidget.py     # 画布视图组件
│   ├── CanvasScene.py      # 画布场景管理
│   └── Node/               # 节点相关组件
│       ├── Node.py         # 节点基类
│       ├── Pin.py          # 引脚实现
│       ├── ConnectionLine.py # 连接线实现
│       ├── RunNodes.py     # 节点执行引擎
│       └── CustomNodes/    # 自定义节点实现
├── Menu/                   # 菜单相关模块
│   ├── NodeListPanel.py   # 节点列表面板
│   └── RightClickMenu.py  # 右键菜单
├── MainWindow.py          # 主窗口
├── WorkflowIO.py          # 工作流输入输出
└── Packages.py           # 包导入
```

## 3. 核心模块详解

### 3.1 主窗口 (MainWindow.py)

#### 3.1.1 功能概述
主窗口是应用程序的顶级容器，负责管理整个应用程序的UI布局和主要功能。

#### 3.1.2 主要组件
- **画布区域**: 用于显示和编辑节点工作流
- **节点列表面板**: 显示可用节点类型，支持拖拽添加
- **菜单栏**: 提供文件操作、编辑、视图等功能
- **工具栏**: 提供常用操作的快捷按钮

#### 3.1.3 关键方法
- `__init__()`: 初始化主窗口，创建UI布局
- `create_menu_bar()`: 创建菜单栏
- `create_tool_bar()`: 创建工具栏
- `add_node()`: 添加新节点
- `clear_scene()`: 清空场景
- `save_workflow()`: 保存工作流
- `import_workflow()`: 导入工作流
- `debug_output()`: 调试输出节点连接状态

### 3.2 画布组件 (CanvasWidget.py)

#### 3.2.1 功能概述
画布组件是工作流编辑的核心视图，负责显示场景内容并处理用户交互。

#### 3.2.2 主要功能
- 显示节点和连接线
- 处理鼠标事件（点击、拖拽、滚轮缩放）
- 支持画布平移和缩放
- 网格背景显示
- 右键菜单和选框选择

#### 3.2.3 关键方法
- `__init__()`: 初始化画布视图
- `drawBackground()`: 绘制网格背景
- `mousePressEvent()`: 处理鼠标按下事件
- `mouseMoveEvent()`: 处理鼠标移动事件
- `mouseReleaseEvent()`: 处理鼠标释放事件
- `wheelEvent()`: 处理滚轮缩放事件
- `keyPressEvent()`: 处理键盘按键事件（如删除键）
- `dragEnterEvent()`: 处理拖拽进入事件
- `dropEvent()`: 处理拖拽放下事件

### 3.3 场景管理 (CanvasScene.py)

#### 3.3.1 功能概述
场景管理器负责管理所有图形项（节点、连接线等），处理图形项之间的交互。

#### 3.3.2 主要功能
- 管理节点和连接线
- 处理节点连接逻辑
- 临时连接线显示
- 连接线创建和删除

#### 3.3.3 关键方法
- `__init__()`: 初始化场景
- `add_node()`: 添加节点到场景
- `create_connection()`: 创建节点连接
- `remove_connection()`: 移除节点连接
- `update_connections()`: 更新所有连接线位置
- `mousePressEvent()`: 处理鼠标按下事件
- `mouseMoveEvent()`: 处理鼠标移动事件
- `mouseReleaseEvent()`: 处理鼠标释放事件

### 3.4 节点系统

#### 3.4.1 节点基类 (Node.py)

##### 3.4.1.1 功能概述
节点基类定义了所有节点的基本属性和行为，是自定义节点的父类。

##### 3.4.1.2 主要组件
- **节点主体**: 矩形区域，显示节点名称
- **输入引脚**: 接收数据输入
- **输出引脚**: 提供数据输出

##### 3.4.1.3 关键方法
- `__init__()`: 初始化节点
- `_init()`: 初始化节点引脚和样式
- `creat_pin()`: 创建引脚
- `_setup_pins()`: 设置引脚位置和样式
- `itemChange()`: 处理节点状态变化
- `run()`: 节点执行方法

#### 3.4.2 引脚系统 (Pin.py)

##### 3.4.2.1 功能概述
引脚系统负责节点的输入输出连接，支持多种数据类型和交互方式。

##### 3.4.2.2 主要组件
- **引脚图形**: 椭圆形图形项，表示引脚
- **文本标签**: 显示数据类型
- **输入控件**: 文本框或下拉框，用于输入值或选择数据类型

##### 3.4.2.3 关键方法
- `__init__()`: 初始化引脚
- `update_appearance()`: 更新引脚外观
- `pin_shape()`: 设置引脚形状
- `_update_pin_color()`: 更新引脚颜色
- `hoverEnterEvent()`: 处理鼠标悬停事件

##### 3.4.2.4 数据类型支持
- `int`: 整数类型
- `str`: 字符串类型
- `bool`: 布尔类型
- `float`: 浮点数类型
- `logic`: 逻辑类型（用于控制流）
- `none`: 无类型（可通过下拉框选择）

#### 3.4.3 连接线 (ConnectionLine.py)

##### 3.4.3.1 功能概述
连接线用于连接节点的输出引脚和输入引脚，表示数据流向。

##### 3.4.3.2 主要功能
- 显示节点间的连接关系
- 支持选中高亮
- 自动更新位置
- 连接状态管理

##### 3.4.3.3 关键方法
- `__init__()`: 初始化连接线
- `update_position()`: 更新连接线位置
- `cleanup_connections()`: 清理连接关系
- `paint()`: 绘制连接线

### 3.5 节点执行引擎 (RunNodes.py)

#### 3.5.1 功能概述
节点执行引擎负责按照正确的顺序执行工作流中的节点，处理数据传递。

#### 3.5.2 执行流程
1. 构建节点依赖图
2. 使用拓扑排序确定执行顺序
3. 生成引脚访问顺序
4. 按顺序执行节点并传递数据

#### 3.5.3 关键方法
- `__init__()`: 初始化执行引擎
- `_build_dependencies()`: 构建节点依赖图
- `_topological_sort()`: 拓扑排序确定执行顺序
- `_generate_pin_order()`: 生成引脚访问顺序
- `debug_()`: 调试输出执行顺序
- `run_node()`: 执行节点

#### 3.5.4 执行特点
- 支持从"Start"节点开始执行
- 确保依赖节点先于被依赖节点执行
- 支持逻辑类型节点的条件执行
- 通过连接关系传递数据

### 3.6 自定义节点系统

#### 3.6.1 节点信息模板 (InfoTemplate.py)

##### 3.6.1.1 功能概述
节点信息模板定义了自定义节点的基本结构和接口。

##### 3.6.1.2 主要属性
- `node_name`: 节点名称（英文）
- `zh_name`: 节点显示名称（中文）
- `input`: 输入引脚配置列表
- `output`: 输出引脚配置列表

##### 3.6.1.3 关键方法
- `__init__()`: 初始化节点信息
- `run()`: 节点执行逻辑
- `logic_check()`: 逻辑检查

#### 3.6.2 预定义节点类型

##### 3.6.2.1 Start节点
- 功能：工作流起始节点，提供逻辑信号
- 输入：无
- 输出：logic类型，值为True

##### 3.6.2.2 Add(int)节点
- 功能：整数加法运算
- 输入：两个int类型值
- 输出：一个int类型结果

##### 3.6.2.3 Print节点
- 功能：打印输出
- 输入：任意类型的值
- 输出：无

##### 3.6.2.4 TypeChange节点
- 功能：数据类型转换
- 输入：任意类型的值，目标类型
- 输出：转换后的值

### 3.7 工作流输入输出 (WorkflowIO.py)

#### 3.7.1 功能概述
工作流输入输出模块负责工作流的保存和加载功能，使用JSON格式存储工作流数据。

#### 3.7.2 数据结构
```json
{
    "nodes": [
        {
            "name": "节点名称",
            "x": x坐标,
            "y": y坐标,
            "node_type": "节点类型",
            "input_pin_values": ["输入值1", "输入值2"],
            "output_pin_values": ["输出值"],
            "input_pin_combo_values": ["输入下拉框值1", "输入下拉框值2"],
            "output_pin_combo_values": ["输出下拉框值"]
        }
    ],
    "connections": [
        {
            "start_node": 起始节点索引,
            "end_node": 结束节点索引,
            "start_pin": 起始引脚索引,
            "end_pin": 结束引脚索引,
            "color": "连接线颜色"
        }
    ]
}
```

#### 3.7.3 关键方法
- `save_workflow()`: 保存工作流到文件
- `load_workflow()`: 从文件加载工作流

#### 3.7.4 保存和加载特点
- 保存节点位置、类型和引脚值
- 保存节点间的连接关系
- 支持引脚下拉框值的保存和恢复
- 处理连接线的颜色和样式

### 3.8 菜单系统

#### 3.8.1 节点列表面板 (NodeListPanel.py)

##### 3.8.1.1 功能概述
节点列表面板显示所有可用的节点类型，支持拖拽添加节点到画布。

##### 3.8.1.2 主要功能
- 显示节点类型列表
- 支持面板折叠和展开
- 支持拖拽节点到画布
- 自定义MIME数据格式

##### 3.8.1.3 关键方法
- `__init__()`: 初始化面板
- `init_ui()`: 初始化用户界面
- `toggle_collapse()`: 切换折叠状态
- `expand_panel()`: 展开面板
- `add_node_type()`: 添加节点类型到列表

#### 3.8.2 右键菜单 (RightClickMenu.py)

##### 3.8.2.1 功能概述
右键菜单提供在画布上快速创建节点的功能。

##### 3.8.2.2 主要功能
- 显示节点类型子菜单
- 支持在点击位置创建节点
- 动态加载可用节点类型

##### 3.8.2.3 关键方法
- `__init__()`: 初始化右键菜单

## 4. 技术特点

### 4.1 可视化编辑
- 基于PyQt6的图形视图框架
- 支持节点拖拽和连接
- 网格背景和对齐
- 画布缩放和平移

### 4.2 数据流处理
- 基于拓扑排序的执行顺序
- 支持多种数据类型
- 引脚连接验证
- 数据类型颜色编码

### 4.3 扩展性设计
- 基于模板的自定义节点系统
- 统一的节点接口
- 可配置的引脚类型和数量
- 支持动态添加节点类型

### 4.4 用户交互
- 多种鼠标交互方式
- 键盘快捷键支持
- 右键菜单操作
- 拖拽操作支持

## 5. 使用示例

### 5.1 创建简单工作流
1. 从节点列表拖拽"开始"节点到画布
2. 拖拽"加法"节点到画布
3. 拖拽"打印"节点到画布
4. 连接"开始"节点到"加法"节点
5. 连接"加法"节点到"打印"节点
6. 在"加法"节点的输入引脚中输入数值
7. 点击"调试输出"按钮执行工作流

### 5.2 保存和加载工作流
1. 点击菜单栏"文件"->"保存"
2. 选择保存位置和文件名
3. 点击"文件"->"导入"
4. 选择之前保存的工作流文件

## 6. 开发指南

### 6.1 添加新节点类型
1. 在`CustomNodes`目录下创建新的节点文件夹
2. 创建`__init__.py`文件，定义节点信息类
3. 继承`InfoTemplate`类，实现`run()`方法
4. 在`node_dict`中注册新节点类型

### 6.2 扩展数据类型
1. 在`pin_colors.py`中添加新数据类型的颜色定义
2. 在`PinTypeComboBox`中添加新数据类型选项
3. 更新相关节点的输入输出配置

### 6.3 自定义节点行为
1. 重写节点的`run()`方法实现特定功能
2. 使用`logic_check()`方法实现条件执行
3. 通过引脚配置定义输入输出接口

## 7. 总结

本工作流引擎提供了一个完整的可视化工作流编辑和执行环境，具有以下特点：

1. **直观的可视化界面**: 基于PyQt6的图形视图框架，提供直观的节点编辑体验。
2. **灵活的节点系统**: 支持多种数据类型和自定义节点，可扩展性强。
3. **强大的执行引擎**: 基于拓扑排序的执行顺序，确保数据正确传递。
4. **完善的交互设计**: 支持多种交互方式，用户体验良好。
5. **标准化的数据格式**: 使用JSON格式保存和加载工作流，便于数据交换。

该工作流引擎适用于各种需要可视化编程和流程控制的场景，如游戏脚本、数据处理、自动化流程等。通过扩展节点类型和功能，可以满足更复杂的应用需求。